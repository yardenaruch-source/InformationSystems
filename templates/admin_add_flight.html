{% extends "base.html" %}
{% block title %}Add Flight{% endblock %}

{% block content %}
<section class="board narrow-board">
  <h2 style="text-align: center;">Add Flight</h2>

  <form method="post" class="form" style="margin-top:12px; max-width:720px;">

    <label class="field-label">Flight ID</label>
    <input class="field-input" name="flight_id" placeholder="e.g. F1234" required>

    <label class="field-label">Route</label>
    <select class="field-input" name="route_id" id="route_id" required>
      {% for r in routes %}
        <option value="{{ r.route_id }}">{{ r.route_id }} — {{ r.origin_airport }} → {{ r.destination_airport }}</option>
      {% endfor %}
    </select>

    <label class="field-label">Flight Duration (minutes)</label>
    <input class="field-input" id="flight_duration" type="text" readonly>

    <label class="field-label">Plane</label>
    <select class="field-input" name="plane_id" required>
      {% for p in planes %}
        <option value="{{ p }}">{{ p }}</option>
      {% endfor %}
    </select>

    <label class="field-label">Manager</label>
    <input class="field-input" type="text"
           value="{{ logged_admin.employee_first_name }} {{ logged_admin.employee_last_name }} — {{ logged_admin.employee_id }}"
           readonly>
    <input type="hidden" name="manager_id" value="{{ logged_admin.employee_id }}">

    <label class="field-label">Takeoff Date</label>
    <input class="field-input" type="date" name="takeoff_date" id="takeoff_date" required>

    <label class="field-label">Takeoff Time</label>
    <input class="field-input" type="time" name="takeoff_time" id="takeoff_time" required>

    <div class="field">
      <label>Landing (auto)</label>
      <div id="landingPreview" class="muted">Select route + takeoff date + takeoff time</div>
    </div>

    <hr style="margin:18px 0; opacity:0.35;">

    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:12px;">
      <div class="card" style="padding:12px;">
        <b>Economy</b>
        <label class="field-label">Price</label>
        <input class="field-input" type="number" step="0.01" min="0" name="econ_price" placeholder="e.g. 399.00">

        <label class="field-label">Rows</label>
        <input class="field-input" id="econ_rows" type="text" readonly>

        <label class="field-label">Columns</label>
        <input class="field-input" id="econ_cols" type="text" readonly>
      </div>

      <div class="card" style="padding:12px;">
        <b>Business</b>
        <label class="field-label">Price</label>
        <input class="field-input" type="number" step="0.01" min="0" name="bus_price" placeholder="e.g. 999.00">

        <label class="field-label">Rows</label>
        <input class="field-input" id="bus_rows" type="text" readonly>

        <label class="field-label">Columns</label>
        <input class="field-input" id="bus_cols" type="text" readonly>
      </div>
    </div>

    <div style="justify-content:center; display:flex; gap:10px; margin-top:14px;">
      <button class="btn" type="submit">Create Flight</button>
    </div>
  </form>
</section>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const layoutMap = {{ layout_map|tojson }};
  const routeMap  = {{ route_map|tojson }};

  const planeSelect = document.querySelector('select[name="plane_id"]');
  const routeSelect = document.querySelector('select[name="route_id"]');

  const dateEl = document.getElementById("takeoff_date");
  const timeEl = document.getElementById("takeoff_time");
  const landingOut = document.getElementById("landingPreview");

  function pad2(n) { return String(n).padStart(2, "0"); }

  function updateLanding() {
    if (!routeSelect || !dateEl || !timeEl || !landingOut) return;

    const rid = routeSelect.value;          // string
    const minutes = routeMap?.[rid];
    const dateStr = dateEl.value;           // "YYYY-MM-DD"
    const timeStr = timeEl.value;           // "HH:MM"

    if (!minutes || !dateStr || !timeStr) {
      landingOut.textContent = "Select route + takeoff date + takeoff time";
      return;
    }

    const [Y, M, D] = dateStr.split("-").map(Number);
    const [h, m] = timeStr.split(":").map(Number);

    const takeoff = new Date(Y, M - 1, D, h, m, 0);
    const landing = new Date(takeoff.getTime() + Number(minutes) * 60000);

    const landingDate = `${landing.getFullYear()}-${pad2(landing.getMonth() + 1)}-${pad2(landing.getDate())}`;
    const landingTime = `${pad2(landing.getHours())}:${pad2(landing.getMinutes())}`;

    landingOut.textContent = `${landingDate} ${landingTime} (duration: ${minutes} min)`;
  }

  function setVal(id, val) {
    const el = document.getElementById(id);
    if (el) el.value = (val ?? "-");
  }

  function updateLayout() {
    if (!planeSelect) return;
    const pid = planeSelect.value;
    const econ = layoutMap?.[pid]?.["Economy"];
    const bus  = layoutMap?.[pid]?.["Business"];
    setVal("econ_rows", econ?.rows);
    setVal("econ_cols", econ?.cols);
    setVal("bus_rows",  bus?.rows);
    setVal("bus_cols",  bus?.cols);
  }

  function updateDuration() {
    if (!routeSelect) return;
    const rid = routeSelect.value;     // string
    setVal("flight_duration", routeMap?.[rid]);
    updateLanding();                   // ✅ add this
  }


  if (planeSelect) {
    planeSelect.addEventListener("change", updateLayout);
    updateLayout();
  }

  if (routeSelect) {
    routeSelect.addEventListener("change", updateDuration);
    updateDuration();
  }

  if (dateEl) dateEl.addEventListener("change", updateLanding);
  if (timeEl) {
    timeEl.addEventListener("change", updateLanding);
    timeEl.addEventListener("input", updateLanding);
  }
  updateLanding();

});
</script>

{% endblock %}


