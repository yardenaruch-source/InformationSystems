{% extends "base.html" %}
{% block title %}Add Flight{% endblock %}

{% block content %}
<section class="board narrow-board">
  <h2 style="text-align: center;">Add Flight</h2>

  <form method="post" class="form" style="margin-top:12px; max-width:720px;">

    <label class="field-label">Flight ID</label>
    <input class="field-input" name="flight_id" placeholder="e.g. F1234" required>

    <label class="field-label">Route</label>
    <select class="field-input" name="route_id" id="route_id" required>
      {% for r in routes %}
        <option value="{{ r.route_id }}">{{ r.route_id }} — {{ r.origin_airport }} → {{ r.destination_airport }}</option>
      {% endfor %}
    </select>

    <label class="field-label">Flight Duration (minutes)</label>
    <input class="field-input" id="flight_duration" type="text" readonly>

    <label class="field-label">Plane</label>
    <select class="field-input" name="plane_id" id="plane_id" required>
      {% for p in planes %}
        <option value="{{ p }}">{{ p }}</option>
      {% endfor %}
    </select>

    <label class="field-label">Plane Size</label>
    <input class="field-input" id="plane_size" type="text" readonly>

    <label class="field-label">Manager</label>
    <input class="field-input" type="text"
           value="{{ logged_admin.employee_first_name }} {{ logged_admin.employee_last_name }} — {{ logged_admin.employee_id }}"
           readonly>
    <input type="hidden" name="manager_id" value="{{ logged_admin.employee_id }}">

    <label class="field-label">Takeoff Date</label>
    <input class="field-input" type="date" name="takeoff_date" id="takeoff_date" required>

    <label class="field-label">Takeoff Time</label>
    <input class="field-input" type="time" name="takeoff_time" id="takeoff_time" required>

    <div class="field">
      <label class="field-label">Landing Preview</label>
      <div id="landingPreview" class="muted" style="padding-left:12px;"></div>
    </div>

    <hr style="margin:18px 0; opacity:0.35;">

    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:12px;">
      <div class="card" style="padding:12px;">
        <b>Economy</b>

        <label class="field-label">Price</label>
        <input class="field-input" type="number" step="0.01" min="0" name="econ_price" placeholder="e.g. 399.00" required>

        <label class="field-label">Rows</label>
        <input class="field-input" id="econ_rows" type="text" readonly>

        <label class="field-label">Columns</label>
        <input class="field-input" id="econ_cols" type="text" readonly>
      </div>

      <div class="card" id="businessCard" style="padding:12px;">
        <b>Business</b>

        <label class="field-label">Price</label>
        <input class="field-input" id="bus_price" type="number" step="0.01" min="0" name="bus_price" placeholder="e.g. 999.00">

        <label class="field-label">Rows</label>
        <input class="field-input" id="bus_rows" type="text" readonly>

        <label class="field-label">Columns</label>
        <input class="field-input" id="bus_cols" type="text" readonly>

        <p class="muted" id="businessHint" style="margin-top:10px; text-align:center;"></p>
      </div>
    </div>

    <hr style="margin:18px 0; opacity:0.35;">

    <h3 style="text-align:center; margin:0 0 10px;">Crew Assignment</h3>

    <div class="muted" id="crewHint" style="text-align:center; margin-bottom:10px;">
      Select route to see required crew (short/long flight)
    </div>

    <label class="field-label">Pilots (select multiple)</label>
    <select class="field-input" name="pilot_ids" id="pilot_ids" multiple size="6" required>
      {% for p in pilots %}
        <option value="{{ p.employee_id }}">
          {{ p.employee_id }} — {{ p.employee_first_name }} {{ p.employee_last_name }}
          {% if p.long_flight_training %}(Long-trained){% endif %}
        </option>
      {% endfor %}
    </select>

    <label class="field-label">Flight Attendants (select multiple)</label>
    <select class="field-input" name="attendant_ids" id="attendant_ids" multiple size="8" required>
      {% for a in attendants %}
        <option value="{{ a.employee_id }}">
          {{ a.employee_id }} — {{ a.employee_first_name }} {{ a.employee_last_name }}
          {% if a.long_flight_training %}(Long-trained){% endif %}
        </option>
      {% endfor %}
    </select>

    <p class="muted" style="text-align:center; margin-top:10px;">
      Tip: hold <b>Ctrl</b> (Windows) / <b>Cmd</b> (Mac) to select multiple.
    </p>

    <div style="justify-content:center; display:flex; gap:10px; margin-top:14px;">
      <button class="btn" type="submit">Create Flight</button>
    </div>
  </form>
</section>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const layoutMap   = {{ layout_map|tojson }};
  const routeMap    = {{ route_map|tojson }};
  const planeSizeMap= {{ plane_size_map|tojson }};

  const planeSelect = document.getElementById("plane_id");
  const routeSelect = document.getElementById("route_id");

  const dateEl = document.getElementById("takeoff_date");
  const timeEl = document.getElementById("takeoff_time");
  const landingOut = document.getElementById("landingPreview");

  const crewHint = document.getElementById("crewHint");
  const planeSizeOut = document.getElementById("plane_size");

  const businessCard = document.getElementById("businessCard");
  const businessHint = document.getElementById("businessHint");
  const busPriceEl   = document.getElementById("bus_price");

  function pad2(n) { return String(n).padStart(2, "0"); }
  function setVal(id, val) {
    const el = document.getElementById(id);
    if (el) el.value = (val ?? "-");
  }

  function updateLanding() {
    const rid = routeSelect.value;
    const minutes = routeMap?.[rid];
    const dateStr = dateEl.value;
    const timeStr = timeEl.value;

    if (!minutes || !dateStr || !timeStr) {
      landingOut.textContent = "Select route + takeoff date + takeoff time";
      return;
    }

    const [Y, M, D] = dateStr.split("-").map(Number);
    const [h, m] = timeStr.split(":").map(Number);

    const takeoff = new Date(Y, M - 1, D, h, m, 0);
    const landing = new Date(takeoff.getTime() + Number(minutes) * 60000);

    const landingDate = `${landing.getFullYear()}-${pad2(landing.getMonth() + 1)}-${pad2(landing.getDate())}`;
    const landingTime = `${pad2(landing.getHours())}:${pad2(landing.getMinutes())}`;

    landingOut.textContent = `${landingDate} ${landingTime} (duration: ${minutes} min)`;
  }

  function updateDurationAndCrewHint(){
    const rid = routeSelect.value;
    const minutes = routeMap?.[rid];
    setVal("flight_duration", minutes);

    if (!minutes || !crewHint) return;

    const isLong = Number(minutes) > 360;
    crewHint.textContent = isLong
      ? "Long flight (> 6h): requires 3 pilots + 6 attendants (long-trained only)"
      : "Short flight (≤ 6h): requires 2 pilots + 3 attendants";

    updateLanding();
  }

  function updatePlaneLayoutAndSize(){
    const pid = planeSelect.value;

    const size = planeSizeMap?.[pid] || "-";
    if (planeSizeOut) planeSizeOut.value = size;

    const econ = layoutMap?.[pid]?.["Economy"];
    const bus  = layoutMap?.[pid]?.["Business"];

    setVal("econ_rows", econ?.rows);
    setVal("econ_cols", econ?.cols);
    setVal("bus_rows",  bus?.rows);
    setVal("bus_cols",  bus?.cols);

    // If Business doesn't exist for this plane (small plane), visually disable Business price.
    const hasBusiness = !!bus;
    if (!hasBusiness){
      if (businessHint) businessHint.textContent = "This plane has Economy only.";
      if (busPriceEl){
        busPriceEl.value = "";
        busPriceEl.disabled = true;
        busPriceEl.placeholder = "Not available";
      }
      if (businessCard) businessCard.style.opacity = "0.6";
    } else {
      if (businessHint) businessHint.textContent = "";
      if (busPriceEl){
        busPriceEl.disabled = false;
        busPriceEl.placeholder = "e.g. 999.00";
      }
      if (businessCard) businessCard.style.opacity = "1";
    }
  }

  // init + listeners
  planeSelect.addEventListener("change", updatePlaneLayoutAndSize);
  routeSelect.addEventListener("change", updateDurationAndCrewHint);

  dateEl.addEventListener("change", updateLanding);
  timeEl.addEventListener("change", updateLanding);
  timeEl.addEventListener("input", updateLanding);

  updatePlaneLayoutAndSize();
  updateDurationAndCrewHint();
  updateLanding();
});
</script>

{% endblock %}
