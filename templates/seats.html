{% extends "base.html" %}
{% block title %}Select Seats{% endblock %}

{% block content %}
<div class="seats-page">

  {% set cols = cabin.columns_num | int %}
  {% if cols == 4 %}
    {% set layout = "cols-4" %}
  {% elif cols == 6 %}
    {% set layout = "cols-6" %}
  {% elif cols == 9 %}
    {% set layout = "cols-9" %}
  {% else %}
    {% set layout = "cols-generic" %}
  {% endif %}

  <div class="seats-layout">

    <!-- LEFT COLUMN -->
    <aside class="seats-side">
      <section class="board seats-header">
        <h2 class="seats-title">Select seats<br>{{ class_type }} (Flight {{ flight_id }})</h2>
        <p class="muted seats-subtitle">
          Price per seat: <span id="seatPrice">{{ "%.2f"|format(cabin.price) }}</span> ₪
        </p>
      </section>

      <section class="board seats-summary">
        <h3 class="seats-box-title">Chosen seats</h3>

        <div class="summary-row">
          <div class="summary-label">Seats</div>
          <div class="summary-value" id="chosenSeats">—</div>
        </div>

        <div class="summary-row">
          <div class="summary-label">Number of seats</div>
          <div class="summary-value" id="seatCount">0</div>
        </div>

        <div class="summary-row summary-total">
          <div class="summary-label">Total price</div>
          <div class="summary-value" id="seatTotal">0.00 ₪</div>
        </div>
      </section>

      <section class="board seats-legend">

        <div class="legend-item">
          <span class="legend-swatch legend-available"></span>
          <span>Available</span>
        </div>

        <div class="legend-item">
          <span class="legend-swatch legend-selected"></span>
          <span>Selected</span>
        </div>

        <div class="legend-item">
          <span class="legend-swatch legend-taken">X</span>
          <span>Taken</span>
        </div>
      </section>
    </aside>

    <!-- RIGHT COLUMN -->
    <main class="seats-main">
      <form method="post">
        <input type="hidden" name="class_type" value="{{ class_type }}"/>

        <div class="seats-wrap">
          <div class="seats-map {{ layout }}" style="--cols: {{ cols }};">
            {% for r in range(1, cabin.rows_num + 1) %}
              <div class="seat-row">
                {% for c in range(1, cabin.columns_num + 1) %}
                  {% set is_taken = taken.get((r,c), False) %}

                  <div class="seat-cell">
                    {% if is_taken %}
                      <span class="seat-taken">X</span>
                    {% else %}
                      <label class="seat-tile">
                        <input type="checkbox" class="seat-check" name="seat" value="{{ r }}-{{ c }}">
                        <span>{{ r }}{{ "ABCDEFGHIJKLMNOPQRSTUVWXYZ"[c-1] if c <= 26 else c }}</span>
                      </label>
                    {% endif %}
                  </div>

                {% endfor %}
              </div>
            {% endfor %}
          </div>
        </div>

        <div class="seats-actions">
          <a class="btn" href="{{ url_for('flight_details', flight_id=flight_id) }}">Back</a>
          <button class="btn" type="submit">Continue to checkout</button>
        </div>
      </form>
    </main>

  </div>
</div>

<script>
  (function () {
    const priceEl = document.getElementById("seatPrice");
    const chosenSeatsEl = document.getElementById("chosenSeats");
    const seatCountEl = document.getElementById("seatCount");
    const seatTotalEl = document.getElementById("seatTotal");

    // Read price once (e.g. "1200.00" or "1200.00 ₪")
    const price = parseFloat((priceEl?.textContent || "0").replace(/[^\d.]/g, "")) || 0;

    // Convert "4-1" -> "4A"
    function toSeatLabel(value) {
      const [rStr, cStr] = String(value).split("-");
      const r = parseInt(rStr, 10);
      const c = parseInt(cStr, 10);

      if (!Number.isFinite(r) || !Number.isFinite(c)) return String(value);

      // 1->A ... 26->Z
      if (c >= 1 && c <= 26) {
        return `${r}${String.fromCharCode(64 + c)}`;
      }

      // Fallback if you ever have >26 columns
      return `${r}-${c}`;
    }

    // Sort by row then column
    function seatSortKey(value) {
      const [rStr, cStr] = String(value).split("-");
      const r = parseInt(rStr, 10);
      const c = parseInt(cStr, 10);
      return { r: Number.isFinite(r) ? r : 999999, c: Number.isFinite(c) ? c : 999999 };
    }

    function updateSummary() {
      const checked = Array.from(document.querySelectorAll(".seat-check:checked"));

      const rawValues = checked.map(cb => cb.value);

      rawValues.sort((a, b) => {
        const A = seatSortKey(a);
        const B = seatSortKey(b);
        return (A.r - B.r) || (A.c - B.c);
      });

      const labels = rawValues.map(toSeatLabel);

      chosenSeatsEl.textContent = labels.length ? labels.join(", ") : "—";
      seatCountEl.textContent = String(labels.length);
      seatTotalEl.textContent = (labels.length * price).toFixed(2) + " ₪";
    }

    // Update whenever a seat checkbox changes
    document.addEventListener("change", (e) => {
      if (e.target && e.target.classList && e.target.classList.contains("seat-check")) {
        updateSummary();
      }
    });

    // Initial load
    updateSummary();
  })();
</script>

{% endblock %}
